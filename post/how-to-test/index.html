<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>怎么样做单测测试 - Piova&#39;s weblog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Piova Chen" /><meta name="description" content="怎么样做单测测试 什么是单元测试 在计算机编程中，单元测试（英语：Unit Testing）又称为模块测试，是针对程序模块（软件设计的最小单位）来" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.55.6 with even 4.0.0" />


<link rel="canonical" href="http://kiminozo.github.io/post/how-to-test/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="怎么样做单测测试" />
<meta property="og:description" content="怎么样做单测测试 什么是单元测试 在计算机编程中，单元测试（英语：Unit Testing）又称为模块测试，是针对程序模块（软件设计的最小单位）来" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://kiminozo.github.io/post/how-to-test/" />
<meta property="article:published_time" content="2019-07-23T16:45:02&#43;08:00"/>
<meta property="article:modified_time" content="2019-07-23T16:45:02&#43;08:00"/>

<meta itemprop="name" content="怎么样做单测测试">
<meta itemprop="description" content="怎么样做单测测试 什么是单元测试 在计算机编程中，单元测试（英语：Unit Testing）又称为模块测试，是针对程序模块（软件设计的最小单位）来">


<meta itemprop="datePublished" content="2019-07-23T16:45:02&#43;08:00" />
<meta itemprop="dateModified" content="2019-07-23T16:45:02&#43;08:00" />
<meta itemprop="wordCount" content="2643">



<meta itemprop="keywords" content="测试,单测,单元测试”,“设计," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="怎么样做单测测试"/>
<meta name="twitter:description" content="怎么样做单测测试 什么是单元测试 在计算机编程中，单元测试（英语：Unit Testing）又称为模块测试，是针对程序模块（软件设计的最小单位）来"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Piova</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Piova</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">怎么样做单测测试</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-07-23 </span>
        <div class="post-category">
            <a href="/categories/%E6%B5%8B%E8%AF%95/"> 测试 </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#怎么样做单测测试">怎么样做单测测试</a>
<ul>
<li><a href="#什么是单元测试">什么是单元测试</a></li>
<li><a href="#如何开始单元测试">如何开始单元测试</a>
<ul>
<li><a href="#分清楚单测需要测什么-不测什么">分清楚单测需要测什么，不测什么</a></li>
<li><a href="#理清楚单元测试的目标">理清楚单元测试的目标</a></li>
</ul></li>
<li><a href="#设计测试用例">设计测试用例</a>
<ul>
<li><a href="#用例需要考虑的条件">用例需要考虑的条件</a></li>
<li><a href="#异常的条件">异常的条件</a></li>
<li><a href="#边界条件">边界条件</a></li>
</ul></li>
<li><a href="#如何让单元测试顺利运行">如何让单元测试顺利运行</a>
<ul>
<li><a href="#准备单测的环境">准备单测的环境</a></li>
<li><a href="#编写环境代码">编写环境代码</a></li>
<li><a href="#如何处理依赖">如何处理依赖</a>
<ul>
<li><a href="#1-直接使用">1.直接使用</a></li>
<li><a href="#2-fake-伪造">2. Fake 伪造</a></li>
<li><a href="#3-stub">3 Stub</a></li>
<li><a href="#4-mock">4 Mock</a></li>
</ul></li>
</ul></li>
<li><a href="#单元测试的结果">单元测试的结果</a>
<ul>
<li><a href="#一个单测的结果">一个单测的结果</a></li>
<li><a href="#单测的覆盖率">单测的覆盖率</a></li>
</ul></li>
<li><a href="#单元测试的工具库">单元测试的工具库</a></li>
<li><a href="#参考文章">参考文章</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h1 id="怎么样做单测测试">怎么样做单测测试</h1>

<h2 id="什么是单元测试">什么是单元测试</h2>

<p>在计算机编程中，单元测试（英语：Unit Testing）又称为模块测试，是针对程序模块（软件设计的最小单位）来进行正确性检验的测试工作。 程序单元是应用的最小可测试部件。 在过程化编程中，一个单元就是单个程序、函数、过程等；对于面向对象编程，最小单元就是方法，包括基类（超类）、抽象类、或者派生类（子类）中的方法。</p>

<p><a href="https://zh.wikipedia.org/zh-hans/单元测试">https://zh.wikipedia.org/zh-hans/单元测试</a></p>

<p>简单说 <strong>单元测试就是对方法测试</strong></p>

<h2 id="如何开始单元测试">如何开始单元测试</h2>

<h3 id="分清楚单测需要测什么-不测什么">分清楚单测需要测什么，不测什么</h3>

<p>已被测试的方法为焦点，大部分的方法在实际使用的情况都可以关系可以被划分成三类
* <strong>使用者</strong> 使用这个方法的类，不需要测试，不会影响单测
* <strong>被测试类</strong> 需要测试方法所属的类，需要测试
* <strong>依赖</strong> 需要测试方法所依赖的类，不需要测试，但是会影响单测</p>

<p><img src="/images/201907/test-dependent.png" alt="image" /></p>

<p>单测需要测试的是被测试方法，其他是不需要测试的。</p>

<h3 id="理清楚单元测试的目标">理清楚单元测试的目标</h3>

<blockquote>
<p>单元测试的目标，就是保证各个单元的逻辑正确性。</p>
</blockquote>

<p>也就是说让每个方法正确，这个方法的使用者不会在调用的时候遇到BUG。减少后期DEBUG的时间。</p>

<p>一般来说 需要对这个方法的输出会有 不同的分支 正常的情况、和多种异常的情况。
将这种分支情况集成到项目中就会出现无数的排列组合，没有人能完全把控，后期DEBUG会非常耗时。
所以编写的单测要进来覆盖这个方法内部的几种输出条件。但是减少单测维护成本，不需要过量的单测。</p>

<h2 id="设计测试用例">设计测试用例</h2>

<p>用例的需要知道几个要素
* 场景(可选)
* 输入
* 输出</p>

<p><strong>使用者</strong> 是一个很好的用例，</p>

<p>举例一个简单的数列的和:</p>

<p>1 + 2 + 3 + 4 + &hellip; + 97 + 98 + 99 + 100 = ?</p>

<p>$f(n)=\sum_{i=1}^n$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">sequence</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">){</span>
   <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
   <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">i</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>假设这个方法的使用者是main函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">(</span><span class="n">100</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<ul>
<li>场景 没有</li>
<li>输入 是100</li>
<li>输出 5050</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sequenceTest</span><span class="o">(){</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">(</span><span class="n">100</span><span class="o">);</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">result</span><span class="o">,</span><span class="n">5050</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="用例需要考虑的条件">用例需要考虑的条件</h3>

<ul>
<li>正常的条件</li>
<li>异常的条件</li>
<li>边界条件</li>
</ul>

<h3 id="异常的条件">异常的条件</h3>

<p>回到sequenceTest的异常条件
如果n = -1 会怎么样</p>

<ul>
<li>场景 没有</li>
<li>输入 n=-1</li>
<li>输出 0</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sequenceTestError</span><span class="o">(){</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">(-</span><span class="n">1</span><span class="o">);</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">result</span><span class="o">,</span><span class="n">0</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>显然这个用例没法通过
我们需要重构一下sequence</p>

<p>$$f(n)=
\begin{cases} n&lt;0: 0<br />
n\geq1:\sum_{i=1}^n
\end{cases}$$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">sequence</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">){</span>
   <span class="k">if</span><span class="o">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">){</span>
       <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
   <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">i</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>现在用例通过了，sequence方法就更健壮了</p>

<h3 id="边界条件">边界条件</h3>

<p>边界就是指判断的边，假设我们的参数是[1,♾) 那么传等于和小于边界的0、1会怎么样呢</p>

<ul>
<li>场景 没有</li>
<li>输入 n=0、1</li>
<li>输出 0、1</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sequenceTestLimit0</span><span class="o">(){</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">result</span><span class="o">,</span><span class="n">0</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sequenceTestLimit1</span><span class="o">(){</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">result</span><span class="o">,</span><span class="n">1</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>运行后发现sequence(0)失败了</p>

<p>$$f(n)=
\begin{cases} n &lt;1: 0<br />
n\geq1:\sum_{i=1}^n
\end{cases}$$</p>

<p>修改一下代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">sequence</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">){</span>
   <span class="k">if</span><span class="o">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">1</span><span class="o">){</span>
       <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
   <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">i</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>现在用例通过了，sequence完成了。</p>

<p>假设发现sequence在处理非常大的数据的时候性能非常慢，我们利用了数学知识把sequence优化了
$$f(n)=
\begin{cases} n &lt;0: 0<br />
n\geq1:(1+n)\times(n \div 2)
\end{cases}$$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">sequence</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">){</span>
   <span class="k">if</span><span class="o">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">1</span><span class="o">){</span>
       <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="o">(</span><span class="n">1</span> <span class="o">+</span> <span class="n">n</span><span class="o">)</span> <span class="o">*</span> <span class="o">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">2</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>重跑测试发现，sequenceTestLimit1失败了
原因是 (n / 2)会变成0
优化后：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">sequence</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">){</span>
   <span class="k">if</span><span class="o">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">1</span><span class="o">){</span>
       <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="o">(</span><span class="n">1</span> <span class="o">+</span> <span class="n">n</span><span class="o">)</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="n">2</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="如何让单元测试顺利运行">如何让单元测试顺利运行</h2>

<ol>
<li>设计并编写测试用例</li>
<li>准备单测运行环境</li>
<li>处理好依赖让单测能够运行</li>
<li>执行单测让其通过</li>
</ol>

<h3 id="准备单测的环境">准备单测的环境</h3>

<blockquote>
<p>单测的环境是一个密闭的环境，</p>

<p>必须保证每次单测运行的结果一致，让各个单测不能相互影响</p>

<p>环境包含静态变量、内存、依赖的类等</p>
</blockquote>

<p>单测也是需要编译成程序来执行的，环境分为</p>

<ul>
<li><strong>测试程序运行环境</strong> 执行的程序可能是jar、exe、apk等等，测试程序执行一次</li>
<li><strong>测试类环境</strong>  <code>@BeforeClass</code>准备数据和<code>@AfterClass</code>清理数据，类生命周期执行一次</li>
<li><strong>测试方法的环境</strong> <code>@Before</code>准备数据和<code>@After</code>清理数据，每个测试用例都要执行一次</li>
</ul>

<h3 id="编写环境代码">编写环境代码</h3>

<ol>
<li>准备好依赖环境对象</li>
<li>确认环境对象的作用范围,合理的使用类<code>@BeforeClass</code>或<code>@Before</code></li>
<li>合适地清理对象</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">FakeService</span> <span class="n">service</span><span class="o">;</span>

    <span class="nd">@BeforeClass</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(){</span>
        <span class="n">service</span><span class="o">.</span><span class="na">init</span><span class="o">()</span>
    <span class="o">}</span>

    <span class="nd">@AfterClass</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">clean</span><span class="o">(){</span>
        <span class="n">service</span><span class="o">.</span><span class="na">clean</span><span class="o">()</span>
    <span class="o">}</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(){</span>
        <span class="n">service</span><span class="o">.</span><span class="na">setUser</span><span class="o">(</span><span class="s">&#34;001&#34;</span><span class="o">,</span><span class="s">&#34;张三&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@After</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(){</span>
        <span class="n">service</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="s">&#34;001&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getUser</span><span class="o">(</span><span class="s">&#34;001&#34;</span><span class="o">);</span>
        <span class="c1">//testDoSomething
</span><span class="c1"></span>    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="如何处理依赖">如何处理依赖</h3>

<p>准备单元测试的环境最麻烦的就是依赖的类，依赖的类有可能是后台服务的接口或者SDK、让单测的密闭性不能保证。
有4种方法来处理：</p>

<h4 id="1-直接使用">1.直接使用</h4>

<p>直接使用认为依赖是一定执行正确且一致的，通畅是系统和运行时提供的方法、稳定的三方库等</p>

<h4 id="2-fake-伪造">2. Fake 伪造</h4>

<blockquote>
<p>Fakes are objects that have working implementations, but not same as production one. Usually they take some shortcut and have simplified version of production code.</p>

<p>Fake 是那些包含了生产环境下具体实现的简化版本的对象。</p>
</blockquote>

<p>在依赖里面经常会遇到数据库、文件和网络操作的依赖</p>

<p><img src="/images/201907/test-fake.png" alt="image" /></p>

<p>Fake 类是将依赖的接口在<strong>保留存取功能</strong>的情况作为一个劣化实现的。
一般做法就是把这些操作简化成内存的数据结构操作。</p>

<p>举例ILogin的Fake实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginFake</span> <span class="kd">implements</span> <span class="n">ILogin</span><span class="o">{</span>
    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">loginList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span><span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">loginList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">bool</span> <span class="nf">isLogined</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
         <span class="k">return</span> <span class="n">loginList</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="3-stub">3 Stub</h4>

<blockquote>
<p>Stub is an object that holds predefined data and uses it to answer calls during tests. It is used when we cannot or don’t want to involve objects that would answer with real data or have undesirable side effects.</p>

<p>Stub 代指那些包含了预定义好的数据并且在测试时返回给调用者的对象。Stub 常被用于我们不希望返回真实数据或者造成其他副作用的场景。</p>
</blockquote>

<p>Stub类是将依赖的接口在<strong>不保留存取功能</strong>的情况，作为一个伪造返回</p>

<p>举例ILogin的Stub实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginFake</span> <span class="kd">implements</span> <span class="n">ILogin</span><span class="o">{</span>
    

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span><span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//Do Nothing
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">bool</span> <span class="nf">isLogined</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
         <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="4-mock">4 Mock</h4>

<blockquote>
<p>Mocks are objects that register calls they receive. In test assertion we can verify on Mocks that all expected actions were performed.</p>

<p>Mocks 代指那些仅记录它们的调用信息的对象，在测试断言中我们需要验证 Mocks 被进行了符合期望的调用。</p>
</blockquote>

<p>假设我们的流程只需要判断ILogin的isLogined()才能执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">(</span><span class="n">ILogin</span> <span class="n">login</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">login</span><span class="o">.</span><span class="na">isLogined</span><span class="o">()){</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//doSomething
</span><span class="c1"></span><span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>用Mock测试doSomething</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDoSomething</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">ILogin</span> <span class="n">login</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">ILogin</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">when</span><span class="o">(</span><span class="n">login</span><span class="o">.</span><span class="na">isLogined</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">doSomething</span><span class="o">(</span><span class="n">login</span><span class="o">);</span>
    <span class="c1">//Do SomeTest
</span><span class="c1"></span><span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Mock可以简化ILogin的定义 减少Stub的ILogin成本。</p>

<h2 id="单元测试的结果">单元测试的结果</h2>

<h3 id="一个单测的结果">一个单测的结果</h3>

<p>每个单测的结果分为 成功、失败、未执行</p>

<p>目标就是让单测都运行成功。</p>

<h3 id="单测的覆盖率">单测的覆盖率</h3>

<p>java里的Coverager 工具能够帮助检查单测覆盖率</p>

<p>这个覆盖率标准可以参考 <a href="http://kiminozo.github.io/post/how-to-test-in-google/">谷歌是怎么样做测试的</a></p>

<p>好的单测能让主要代码能够覆盖100%，但是<font color=#FF0000>覆盖100%并不代表所有逻辑都覆盖了。</font></p>

<p>所以单测覆盖率的作用主要是<strong>检查没有覆盖的代码</strong>。</p>

<h2 id="单元测试的工具库">单元测试的工具库</h2>

<ul>
<li><a href="https://junit.org/junit5/">JUnit</a> 基本库</li>
<li><a href="https://site.mockito.org/">mockito</a> 比较流行的Mock工具，同类的还有JMock</li>
<li><a href="https://github.com/powermock/powermock">powermock</a> 支持静态类Mock的库</li>
<li><a href="https://github.com/jOOQ/jOOR">joor-java</a> 反射工具库 单测需要经常需要用反射修改内部的方法和变量</li>
</ul>

<h2 id="参考文章">参考文章</h2>

<p><a href="https://zhuanlan.zhihu.com/p/26942686">https://zhuanlan.zhihu.com/p/26942686</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Piova Chen</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2019-07-23
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E6%B5%8B%E8%AF%95/">测试</a>
          <a href="/tags/%E5%8D%95%E6%B5%8B/">单测</a>
          <a href="/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E8%AE%BE%E8%AE%A1/">单元测试”,“设计</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/api-design/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">设计API的原则---读《软件框架设计艺术》</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/how-to-test-in-google/">
            <span class="next-text nav-default">谷歌是怎么样做测试的</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2019-07-23 16:45:02 \x2b0800 CST',
        title: '怎么样做单测测试',
        clientID: 'd7b6d695fbddd731f9bb',
        clientSecret: '2b147c5e72cb946651a8f219050d2db127f90332',
        repo: 'kiminozo.github.io',
        owner: 'kiminozo',
        admin: ['kiminozo'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>
  
  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="http://www.gitHub.com/kiminozo" class="iconfont icon-github" title="github"></a>
  <a href="http://kiminozo.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Piova Chen</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>
</html>
